---
layout: post
title: "Deriving Simple Recurrence Formulas for Mean and Variance"
date: 2025-10-30 10:00:00 +0100
categories: statistics homework
---

# Deriving Simple Recurrence Formulas for Mean and Variance

When processing data streams or large datasets, recalculating the mean and variance from scratch for every new observation ($X_n$) is computationally inefficient [1]. Instead, we can use **recurrence (or online) formulas** that update the statistics based only on the previous statistics (for $n-1$ observations) and the new observation [1]. This approach simplifies the process considerably and is often essential in real-time applications [1].

## 1. Recursive Formula for the Mean

The mean of $n$ observations ($\bar{X}_n$) is defined as [2]:

<ul style="list-style-type: none;">
  <li>
    <strong>Mean Definition:</strong><br>
    <code>\bar{X}_n = \frac{1}{n} \sum_{i=1}^{n} X_i</code>
  </li>
</ul>

We can separate the sum into the first $n-1$ elements and the $n$-th element ($X_n$) [2].

<ul style="list-style-type: none;">
  <li>
    <strong>Separating the Sum:</strong><br>
    <code>\bar{X}_n = \frac{1}{n} \left( \sum_{i=1}^{n-1} X_i + X_n \right)</code>
  </li>
</ul>

We know that the sum of the first $n-1$ elements is equal to $(n-1)$ times the previous mean ($\bar{X}_{n-1}$) [2]:

<ul style="list-style-type: none;">
  <li>
    <strong>Sum Substitution:</strong><br>
    <code>\sum_{i=1}^{n-1} X_i = (n-1) \bar{X}_{n-1}</code>
  </li>
</ul>

Substituting this back into the formula for $\bar{X}_n$ [3]:

<ul style="list-style-type: none;">
  <li>
    <strong>Intermediate Recurrence 1:</strong><br>
    <code>\bar{X}_n = \frac{1}{n} \left( (n-1) \bar{X}_{n-1} + X_n \right)</code>
  </li>
</ul>

To simplify, we can rewrite $(n-1)/n$ as $1 - 1/n$ [3]:

<ul style="list-style-type: none;">
  <li>
    <strong>Intermediate Recurrence 2:</strong><br>
    <code>\bar{X}_n = \left( 1 - \frac{1}{n} \right) \bar{X}_{n-1} + \frac{1}{n} X_n</code>
  </li>
</ul>

Alternatively, a very simple and numerically stable recursive update can be derived by calculating the difference (or error) caused by the new observation [3]. **This final formula is the simplest recurrence relation for the mean** [3]. The term $ (X_n - \bar{X}_{n-1}) $ is the error, which is then corrected by distributing it across all $n$ observations [3].

<ul style="list-style-type: none;">
  <li>
    <strong>Simplest Recurrence for Mean:</strong><br>
    <code>\bar{X}_n = \bar{X}_{n-1} + \frac{X_n - \bar{X}_{n-1}}{n}</code>
  </li>
</ul>

## 2. Recursive Formula for the Variance

The variance is typically calculated using the sum of squared differences from the mean [4]. Let $S_n$ be the sum of squared differences for $n$ observations [4]:

<ul style="list-style-type: none;">
  <li>
    <strong>Definition of Sum of Squared Differences ($S_n$):</strong><br>
    <code>S_n = \sum_{i=1}^{n} (X_i - \bar{X}_n)^2</code>
  </li>
</ul>

For recursive calculation, we focus on how $S_n$ relates to $S_{n-1}$ and the new data point $X_n$ [4]. This derivation often follows **Welfordâ€™s method** to maintain numerical stability [4].

The new sum $S_n$ can be related to $S_{n-1}$ using the following update [4], which incorporates the previous mean ($\bar{X}_{n-1}$) and the new mean ($\bar{X}_n$):

<ul style="list-style-type: none;">
  <li>
    <strong>$S_n$ Update Relation:</strong><br>
    <code>S_n = S_{n-1} + (X_n - \bar{X}_{n-1})(X_n - \bar{X}_n)</code>
  </li>
</ul>

We substitute the mean update formula ($\bar{X}_n = \bar{X}_{n-1} + \delta_n / n$, where $\delta_n = X_n - \bar{X}_{n-1}$ is the error) [5]:

<ul style="list-style-type: none;">
  <li>
    <strong>Substitution and Simplification:</strong><br>
    <code>S_n = S_{n-1} + \delta_n \left( \delta_n - \frac{\delta_n}{n} \right)</code>
  </li>
</ul>

Simplifying this leads to the **recurrence formula for the sum of squared differences** [5]:

<ul style="list-style-type: none;">
  <li>
    <strong>Recurrence Formula for $S_n$:</strong><br>
    <code>S_n = S_{n-1} + \frac{n-1}{n} (X_n - \bar{X}_{n-1})^2</code>
  </li>
</ul>

Once $S_n$ is calculated, the sample variance $V_n$ is obtained by dividing by $n-1$ (for $n>1$) [5]:

<ul style="list-style-type: none;">
  <li>
    <strong>Sample Variance:</strong><br>
    <code>V_n = \frac{S_n}{n-1}</code>
  </li>
</ul>

## 3. Example Code Implementation

The following Python code demonstrates the use of these recurrence formulas to calculate the mean and variance sequentially as new data arrives [6]. This implements a stable, single-pass algorithm often used in data streaming environments [6].

```python
import random

def calculate_online_statistics(data_stream):
    """
    Calculates the mean and variance recursively (online method).
    Uses the formulas derived above for computational efficiency.
    """
    n = 0
    mean = 0.0
    M2 = 0.0 # M2 is the sum of squares of differences (S_n)

    for x in data_stream: 
        n += 1 
        if n == 1: 
            mean = x 
            M2 = 0.0 
        else: 
            # 1. Update Mean (Recurrence Formula: X_bar_n = X_bar_(n-1) + (X_n - X_bar_(n-1)) / n) 
            delta = x - mean 
            mean += delta / n 
            
            # 2. Update Sum of Squared Differences (Recurrence Formula for S_n) 
            # This is the Welford update optimized for stability: 
            delta2 = x - mean 
            M2 += delta * delta2 
    
    variance = M2 / (n - 1) if n > 1 else 0.0 
    return mean, variance, n
    
# Example usage with random data
data = [random.randint(1, 100) for _ in range(10)] 
final_mean, final_variance, total_count = calculate_online_statistics(data)

print(f"Data Stream: {data}") [7]
print(f"Total Observations (n): {total_count}") [7]
print(f"Online Mean: {final_mean:.4f}") [7]
print(f"Online Variance: {final_variance:.4f}") [7]

# Compare with built-in functions (using numpy for comparison only)
try: 
    import numpy as np 
    np_mean = np.mean(data) 
    np_variance = np.var(data, ddof=1) # ddof=1 for sample variance 
    print("\n--- Verification (Numpy) ---") [7]
    print(f"Numpy Mean: {np_mean:.4f}") [7]
    print(f"Numpy Sample Variance: {np_variance:.4f}") [7]
except ImportError: 
    pass